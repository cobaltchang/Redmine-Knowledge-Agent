# 威脅建模報告 (Threat Model Report)

## 文件資訊

**專案**: Redmine Knowledge Agent  
**版本**: 2.0.0  
**建模方法**: STRIDE + Attack Trees  
**建模日期**: 2026-01-26  
**審核狀態**: 初版

---

## 1. 系統概述

### 1.1 系統描述

Redmine Knowledge Agent 是一個自動化知識提取工具，從 Redmine 伺服器抓取 Issues 與 Wiki 頁面，處理附件（OCR、PDF解析等），並轉換為結構化 Markdown 檔案。

### 1.2 資料流圖 (Data Flow Diagram)

```
                                    ┌─────────────────┐
                                    │   使用者/操作員  │
                                    └────────┬────────┘
                                             │ (1) CLI 指令
                                             ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                            Trust Boundary                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌───────────┐ │
│  │   Config    │───▶│   Redmine   │───▶│  Processor  │───▶│ Generator │ │
│  │   Loader    │    │   Client    │    │   Factory   │    │           │ │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └─────┬─────┘ │
│         │                  │                  │                  │       │
└─────────┼──────────────────┼──────────────────┼──────────────────┼───────┘
          │ (2)              │ (3)              │ (4)              │ (5)
          ▼                  ▼                  ▼                  ▼
    ┌───────────┐      ┌───────────┐      ┌───────────┐      ┌───────────┐
    │ .env      │      │ Redmine   │      │ Tesseract │      │ 本地檔案   │
    │ config.yaml│     │ API Server│      │ OCR Engine│      │ 系統       │
    └───────────┘      └───────────┘      └───────────┘      └───────────┘
      環境變數            外部服務            外部程式            輸出目錄
```

### 1.3 信任邊界識別

| 邊界 | 描述 | 信任等級 |
|------|------|----------|
| TB-1 | 應用程式內部 | 高信任 |
| TB-2 | 配置檔/環境變數 | 中信任（操作員可控） |
| TB-3 | Redmine API | 低信任（外部服務） |
| TB-4 | 外部處理程式 | 低信任（OCR等） |
| TB-5 | 檔案系統 | 中信任（輸出目錄） |

---

## 2. 資產識別

### 2.1 資料資產

| 資產 ID | 資產名稱 | 機密性 | 完整性 | 可用性 | 說明 |
|---------|----------|--------|--------|--------|------|
| A-001 | Redmine API Key | **高** | 高 | 高 | 可存取所有授權資料 |
| A-002 | 配置檔內容 | **高** | 高 | 中 | 包含連線資訊 |
| A-003 | Issue 內容 | 中 | 中 | 低 | 業務資訊 |
| A-004 | Wiki 內容 | 中 | 中 | 低 | 技術文件 |
| A-005 | 附件檔案 | 中 | 低 | 低 | 可能含敏感文件 |
| A-006 | 輸出 Markdown | 中 | 高 | 中 | 彙整後的知識 |
| A-007 | 執行日誌 | 低 | 中 | 中 | 操作記錄 |

### 2.2 系統資產

| 資產 ID | 資產名稱 | 重要性 | 說明 |
|---------|----------|--------|------|
| S-001 | 應用程式執行環境 | 高 | Python runtime |
| S-002 | 網路連線 | 高 | Redmine API 通訊 |
| S-003 | 檔案系統存取 | 中 | 讀寫輸出目錄 |

---

## 3. STRIDE 威脅分析

### 3.1 Spoofing (身份偽造)

| 威脅 ID | 威脅描述 | 攻擊向量 | 影響資產 | 風險等級 | 緩解措施 |
|---------|----------|----------|----------|----------|----------|
| S-001 | 偽造 Redmine API 回應 | MITM 攻擊偽造 API 回應 | A-003, A-004 | 中 | TLS 憑證驗證 |
| S-002 | 偽造配置檔 | 替換 config.yaml | A-001, A-002 | 高 | 檔案權限控制、完整性檢查 |
| S-003 | 偽造環境變數 | 修改系統環境 | A-001 | 中 | 執行環境隔離 |

### 3.2 Tampering (篡改)

| 威脅 ID | 威脅描述 | 攻擊向量 | 影響資產 | 風險等級 | 緩解措施 |
|---------|----------|----------|----------|----------|----------|
| T-001 | 傳輸中資料篡改 | MITM 修改 API 回應 | A-003, A-004 | 中 | HTTPS + 憑證驗證 |
| T-002 | 輸出檔案篡改 | 直接修改 Markdown 檔 | A-006 | 低 | 輸出目錄權限控制 |
| T-003 | 日誌篡改 | 刪除/修改日誌記錄 | A-007 | 低 | 日誌完整性保護 |

### 3.3 Repudiation (否認)

| 威脅 ID | 威脅描述 | 攻擊向量 | 影響資產 | 風險等級 | 緩解措施 |
|---------|----------|----------|----------|----------|----------|
| R-001 | 否認執行操作 | 未記錄的資料存取 | A-003, A-004 | 低 | 結構化日誌 + 時間戳 |
| R-002 | 否認配置變更 | 修改配置後無記錄 | A-002 | 低 | 配置變更日誌 |

### 3.4 Information Disclosure (資訊洩露)

| 威脅 ID | 威脅描述 | 攻擊向量 | 影響資產 | 風險等級 | 緩解措施 |
|---------|----------|----------|----------|----------|----------|
| I-001 | API Key 洩露至日誌 | 日誌記錄敏感資訊 | A-001 | **高** | 敏感資料過濾器 |
| I-002 | API Key 洩露至版控 | .env 提交到 Git | A-001 | **高** | .gitignore + pre-commit |
| I-003 | 配置檔權限過寬 | 檔案權限 644 | A-001, A-002 | 中 | 檔案權限 600 |
| I-004 | 錯誤訊息洩露資訊 | 詳細錯誤訊息 | A-001, A-002 | 中 | 安全錯誤處理 |
| I-005 | 記憶體中敏感資料 | Memory dump | A-001 | 低 | 使用後清除敏感變數 |
| I-006 | 輸出目錄公開存取 | 錯誤的目錄權限 | A-006 | 中 | 輸出目錄權限控制 |

### 3.5 Denial of Service (阻斷服務)

| 威脅 ID | 威脅描述 | 攻擊向量 | 影響資產 | 風險等級 | 緩解措施 |
|---------|----------|----------|----------|----------|----------|
| D-001 | Redmine API 過載 | 大量 API 請求 | S-002 | 中 | Rate limiting |
| D-002 | 磁碟空間耗盡 | 大量附件下載 | S-003 | 中 | 磁碟空間檢查 |
| D-003 | 記憶體耗盡 | 處理大型檔案 | S-001 | 中 | 檔案大小限制 |
| D-004 | OCR 處理阻塞 | 大型圖片處理 | S-001 | 低 | 處理逾時設定 |

### 3.6 Elevation of Privilege (權限提升)

| 威脅 ID | 威脅描述 | 攻擊向量 | 影響資產 | 風險等級 | 緩解措施 |
|---------|----------|----------|----------|----------|----------|
| E-001 | 路徑遍歷攻擊 | 惡意檔案名稱 | S-003 | **高** | 路徑驗證 |
| E-002 | 命令注入 | 惡意附件名稱 | S-001 | 中 | 輸入驗證 |
| E-003 | API Key 權限過大 | 使用管理員 key | A-001 | 中 | 最小權限原則 |

---

## 4. 攻擊樹分析

### 4.1 攻擊目標：竊取 API Key

```
[竊取 Redmine API Key]
├── [1] 從配置檔取得
│   ├── [1.1] 讀取 .env 檔案
│   │   ├── [1.1.1] 檔案權限過寬 (緩解: chmod 600)
│   │   └── [1.1.2] 本地使用者提權 (緩解: 系統安全)
│   ├── [1.2] 讀取 config.yaml
│   │   └── [1.2.1] API Key 明文儲存 (緩解: 環境變數引用)
│   └── [1.3] 讀取版本控制歷史
│       └── [1.3.1] 曾經提交敏感資料 (緩解: pre-commit hook)
│
├── [2] 從執行環境取得
│   ├── [2.1] 讀取環境變數
│   │   └── [2.1.1] 進程環境洩露 (緩解: 進程隔離)
│   ├── [2.2] 記憶體擷取
│   │   └── [2.2.1] Debug/core dump (緩解: 禁用 core dump)
│   └── [2.3] 日誌檔案
│       └── [2.3.1] 敏感資料記錄 (緩解: 日誌過濾)
│
└── [3] 從網路攻擊取得
    ├── [3.1] MITM 攔截
    │   └── [3.1.1] HTTP 傳輸 (緩解: 強制 HTTPS)
    └── [3.2] 網路嗅探
        └── [3.2.1] 明文傳輸 (緩解: TLS 加密)
```

### 4.2 攻擊目標：未授權資料存取

```
[未授權存取 Redmine 資料]
├── [1] 繞過認證
│   ├── [1.1] 竊取 API Key (見 4.1)
│   └── [1.2] 偽造請求
│       └── [1.2.1] CSRF 攻擊 (不適用: CLI 工具)
│
├── [2] 利用應用程式漏洞
│   ├── [2.1] 路徑遍歷
│   │   └── [2.1.1] 惡意檔案名 (緩解: 路徑驗證)
│   └── [2.2] 注入攻擊
│       └── [2.2.1] 命令注入 (緩解: 輸入驗證)
│
└── [3] 利用配置錯誤
    ├── [3.1] API Key 權限過大
    │   └── [3.1.1] 管理員 key (緩解: 最小權限)
    └── [3.2] 輸出目錄公開
        └── [3.2.1] 權限設定錯誤 (緩解: 權限檢查)
```

---

## 5. 風險評估矩陣

### 5.1 風險等級定義

| 可能性 \ 影響 | 低 (1) | 中 (2) | 高 (3) |
|---------------|--------|--------|--------|
| 高 (3) | 中 | 高 | **嚴重** |
| 中 (2) | 低 | 中 | 高 |
| 低 (1) | 低 | 低 | 中 |

### 5.2 風險評估結果

| 威脅 ID | 威脅描述 | 可能性 | 影響 | 風險等級 | 優先處理 |
|---------|----------|--------|------|----------|----------|
| I-001 | API Key 洩露至日誌 | 中 | 高 | **高** | ✅ |
| I-002 | API Key 洩露至版控 | 中 | 高 | **高** | ✅ |
| E-001 | 路徑遍歷攻擊 | 中 | 高 | **高** | ✅ |
| S-001 | MITM 偽造回應 | 低 | 中 | 低 | |
| D-001 | API 過載 | 中 | 中 | 中 | ✅ |
| I-003 | 配置檔權限過寬 | 中 | 中 | 中 | ✅ |

---

## 6. 緩解措施實作狀態

### 6.1 已實作

| 措施 ID | 描述 | 對應威脅 | 實作位置 |
|---------|------|----------|----------|
| M-001 | 環境變數讀取 API Key | I-001, I-002 | `config.py` |
| M-002 | .gitignore 排除 .env | I-002 | `.gitignore` |
| M-003 | HTTPS 連線 | S-001, T-001 | `client.py` |
| M-004 | 路徑驗證 | E-001 | `generator.py` |
| M-005 | Rate limiting | D-001 | `client.py` |
| M-006 | Pydantic 輸入驗證 | E-002 | `models.py` |

### 6.2 待實作

| 措施 ID | 描述 | 對應威脅 | 優先級 |
|---------|------|----------|--------|
| M-007 | Pre-commit hook 敏感資料檢查 | I-002 | 高 |
| M-008 | 日誌敏感資料過濾 | I-001 | 高 |
| M-009 | 檔案大小限制 | D-002, D-003 | 中 |
| M-010 | 處理逾時設定 | D-004 | 中 |

---

## 7. 安全測試建議

### 7.1 靜態分析

- [x] Ruff (flake8-bandit) 安全規則
- [ ] Bandit 深度掃描
- [ ] Semgrep 自訂規則

### 7.2 依賴掃描

- [ ] pip-audit 漏洞掃描
- [ ] SBOM 產生與追蹤

### 7.3 動態測試

- [ ] 路徑遍歷測試
- [ ] 大檔案處理測試
- [ ] 錯誤處理測試

---

## 8. 結論與建議

### 8.1 主要風險摘要

1. **API Key 洩露** - 最高優先，需確保所有日誌和版控都不包含敏感資訊
2. **路徑遍歷** - 已有基本防護，需加強測試驗證
3. **DoS 攻擊** - 建議加入資源限制機制

### 8.2 後續行動

1. 實作 pre-commit hook 檢查敏感資料
2. 加入 Bandit 和 pip-audit 到 CI
3. 產生並維護 SBOM
4. 定期更新威脅模型

---

## 附錄 A: 參考資料

- [OWASP Threat Modeling](https://owasp.org/www-community/Threat_Modeling)
- [STRIDE Model](https://docs.microsoft.com/en-us/azure/security/develop/threat-modeling-tool-threats)
- [Attack Trees - Bruce Schneier](https://www.schneier.com/academic/archives/1999/12/attack_trees.html)

---

## 文件變更歷史

| 版本 | 日期 | 變更者 | 變更說明 |
|------|------|--------|----------|
| 1.0.0 | 2026-01-26 | AI Assistant | 初始威脅建模 |
